FROM python:3.11.1-slim as requirements-stage
WORKDIR /tmp
RUN pip install --no-cache-dir --upgrade pip
RUN pip install --no-cache-dir poetry
COPY ./zpodapi/pyproject.toml ./zpodapi/poetry.lock* /tmp/
ARG INSTALL_DEV=false
RUN bash -c "if [ $INSTALL_DEV == 'true' ] ; then poetry export --dev -f requirements.txt --output requirements.txt --without-hashes ; else poetry export -f requirements.txt --output requirements.txt --without-hashes ; fi"

# BASE
FROM python:3.11.1-slim as base
RUN pip install --no-cache-dir --upgrade pip
COPY --from=requirements-stage /tmp/requirements.txt /requirements.txt
RUN pip install --no-cache-dir --upgrade -r /requirements.txt
WORKDIR /zpodcore
ENV PYTHONPATH=/zpodcore/src
CMD ["tail", "-f", "/dev/null"]

# DEV
FROM base as dev
CMD ["python", "/zpodcore/scripts/startup/start_reload.py"]

# PROD
FROM base as production
COPY ./zpodapi/scripts /zpodcore/scripts
COPY ./zpodapi/tests /zpodcore/tests
COPY ./zpodapi/src/zpodapi /zpodcore/src/zpodapi
COPY ./zpodcommon/src/zpodcommon /zpodcore/src/zpodcommon
CMD ["python", "/zpodcore/scripts/startup/start.py"]
